@model ShoppingCart

@{
    ViewData["Title"] = "Index";
    decimal total = 0;
}
<h2 class="text-center my-4">Giỏ hàng của bạn</h2>

<div class="container">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th scope="col">Sản phẩm</th>
                    <th scope="col">Số lượng</th>
                    <th scope="col">Giá </th>
                    <th scope="col">Tổng cộng</th>
                    <th scope="col">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>
                            <button class="btn btn-sm btn-outline-dark decreasement" data-product-id="@item.ProductId">-</button>
                            <span class="quantity" data-price="@item.Price">@item.Quantity</span>
                            <button class="btn btn-sm btn-outline-dark increment" data-product-id="@item.ProductId">+</button>
                        </td>
                        <td>@item.Price </td>
                        <td class="total">@(item.Price * item.Quantity) </td>
                        <td>
                            <a class="btn btn-outline-danger" asp-action="RemoveFromCart" asp-route-productId="@item.ProductId">Xóa</a>
                            
                        </td>
                    </tr>
                    total = total + (item.Price * item.Quantity);
                }
            </tbody>
            <a class="btn btn-outline-primary" asp-controller="ShoppingCart" asp-action="OrderList">Đơn hàng đã đặt</a>
        </table>
        <h5 class="btn btn-block btn-lg" style="width: 100%; cursor: default; background-color: #ffc107;">
            Tổng tiền:
            <span style="font-weight: bold; color: #dc3545;">@total</span> VNĐ
        </h5>
        <a class="btn btn-outline-primary" asp-controller="ShoppingCart" asp-action="Checkout">Thanh toán</a>
        <div class="card-footer text-muted text-center">
            <a asp-area="" asp-controller="Home" asp-action="Index" class="btn btn-outline-primary">Tiếp tục mua hàng </a>
        </div>
        
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            $('.increment, .decreasement').click(function () {
                var productId = $(this).data('product-id');
                var quantityElement = $(this).siblings('.quantity');
                var currentQuantity = parseInt(quantityElement.text());

                if ($(this).hasClass('increment')) {
                    quantityElement.text(currentQuantity + 1);
                } else {
                    if (currentQuantity > 1) {
                        quantityElement.text(currentQuantity - 1);
                    } else {
                        alert("Số lượng không thể nhỏ hơn 1");
                    }
                }
                updateTotal($(this));
                updateCart(productId, parseInt(quantityElement.text())); //Chuyển đối số là số lượng đã được cập nhật.
            });
        });


        function updateTotal(button) {
            var quantityElement = button.siblings('.quantity');
            var currentQuantity = parseInt(quantityElement.text());
            var price = parseFloat(quantityElement.data('price'));
            var totalElement = button.closest('tr').find('.total');
            var totalValue = price * currentQuantity;
            totalElement.text(totalValue.toFixed(2));
        }

        function updateCart(productId, quantity) {
            $.ajax({
                type: "POST",
                url: "/ShoppingCart/UpdateCart", // URL đến phương thức hành động của bạn
                data: { productId: productId, quantity: quantity },
                success: function (response) {
                    // Xử lý thành công nếu cần.
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                            // Xử lý lỗi nếu cần.
                }
            });
        }

    </script>
}