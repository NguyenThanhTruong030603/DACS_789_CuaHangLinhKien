@model ShoppingCart

@{
    ViewData["Title"] = "Index";
    decimal total = Model.Items.Sum(i => i.Price * i.Quantity);
    decimal discountAmount = 0;
    decimal discountPercentage = Model.DiscountPercentage;
    decimal finalPrice = total;

    if (!string.IsNullOrEmpty(Model.DiscountCode))
    {
        discountAmount = total * discountPercentage / 100;
        finalPrice = total - discountAmount;
    }
}

<h2 class="text-center my-4">Giỏ hàng của bạn</h2>

<div class="container">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th scope="col">Sản phẩm</th>
                    <th scope="col">Số lượng</th>
                    <th scope="col">Giá</th>
                    <th scope="col">Tổng cộng</th>
                    <th scope="col">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>
                            <button class="btn btn-sm btn-outline-dark decreasement" data-product-id="@item.ProductId">-</button>
                            <span class="quantity" data-price="@item.Price">@item.Quantity</span>
                            <button class="btn btn-sm btn-outline-dark increment" data-product-id="@item.ProductId">+</button>
                        </td>
                        <td>@item.Price</td>
                        <td class="total">@(item.Price * item.Quantity)</td>
                        <td>
                            <a class="btn btn-outline-danger" asp-action="RemoveFromCart" asp-route-productId="@item.ProductId">Xóa</a>
                        </td>
                    </tr>
                }
                <tr>
                    <td colspan="3"></td>
                    <td>
                        <div class="text-right">
                            <div class="summary-section mt-3 text-right">
                                <form asp-action="ApplyDiscount" method="post" class="discount-form d-inline-block">
                                    <div class="input-group mb-3">
                                        <input type="text" id="discountCode" name="discountCode" class="form-control" placeholder="Mã giảm giá" />
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-primary">Áp dụng</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="totals">
                                <p class="mb-2"><strong>Tổng tạm tính:</strong> <span id="totalPriceValue" class="font-weight-bold text-danger">@total</span> VNĐ</p>
                                <p class="mb-2"><strong>Giảm giá (<span class="font-weight-bold">@discountPercentage%</span>):</strong> <span id="discountAmount" class="text-success font-weight-bold">-@discountAmount</span></p>
                                <p class="mb-2"><strong>Thành tiền:</strong> <span id="finalPriceValue" class="text-primary font-weight-bold">@finalPrice</span></p>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <a class="btn btn-outline-primary mt-3" asp-controller="ShoppingCart" asp-action="Checkout">Thanh toán</a>
        <div class="card-footer text-muted text-center mt-3">
            <a asp-area="" asp-controller="Home" asp-action="Index" class="btn btn-outline-primary">Tiếp tục mua hàng</a>
        </div>
        <a class="btn btn-outline-primary mt-3" asp-controller="ShoppingCart" asp-action="OrderList">Đơn hàng đã đặt</a>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            $('.increment, .decreasement').click(function () {
                var productId = $(this).data('product-id');
                var quantityElement = $(this).siblings('.quantity');
                var currentQuantity = parseInt(quantityElement.text());

                if ($(this).hasClass('increment')) {
                    quantityElement.text(currentQuantity + 1);
                } else {
                    if (currentQuantity > 1) {
                        quantityElement.text(currentQuantity - 1);
                    } else {
                        alert("Số lượng không thể nhỏ hơn 1");
                    }
                }
                updateTotal($(this));
                updateCart(productId, parseInt(quantityElement.text()));
            });
        });

        function updateTotal(button) {
            var quantityElement = button.siblings('.quantity');
            var currentQuantity = parseInt(quantityElement.text());
            var price = parseFloat(quantityElement.data('price'));
            var totalElement = button.closest('tr').find('.total');
            var totalValue = price * currentQuantity;
            totalElement.text(totalValue.toFixed(2));
            updateTotalPrice();
        }

        function updateTotalPrice() {
            var totalPrice = 0;
            $('.total').each(function () {
                totalPrice += parseFloat($(this).text());
            });
            $('#totalPriceValue').text(totalPrice.toFixed(2));
            updateDiscountAndFinalPrice();
        }

        function updateDiscountAndFinalPrice() {
            var totalPrice = parseFloat($('#totalPriceValue').text());
            var discountPercentage = @discountPercentage;
            var discountAmount = totalPrice * discountPercentage / 100;
            var finalPrice = totalPrice - discountAmount;
            $('#discountAmount').text('-' + discountAmount.toFixed(2));
            $('#finalPriceValue').text(finalPrice.toFixed(2));
        }

        function updateCart(productId, quantity) {
            $.ajax({
                type: "POST",
                url: "/ShoppingCart/UpdateCart",
                data: { productId: productId, quantity: quantity },
                success: function (response) {
                    // Successful update
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }
    </script>
}

@* <style>
    .summary-section {
        margin-top: 20px;
    }

    .total-price {
        background-color: #ffc107;
        color: #dc3545;
    }

    .discount-form {
        display: flex;
        align-items: center;
    }

    .discount-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
    }

        .discount-info p {
            margin: 0;
        }

    .input-group {
        width: 300px;
        margin-left: auto;
    }

    .totals {
        margin-top: 10px;
    }

        .totals p {
            margin: 0;
        }
</style> *@
